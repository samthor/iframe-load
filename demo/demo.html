<!DOCTYPE html>
<html>
<head>

<script type="module">

  const pagesToLoad = ['message.html', 'frame1.html', 'frame2.html'];

  import {Loader} from '../iframe-loader.js';

  const portForFrame = new WeakMap();

  const TestLoader = class extends Loader {
    async unload(frame) {
      console.info('delaying unload by 1s');
      await new Promise((r) => window.setTimeout(r, 1000));
    }

    async prepare(frame) {
      return new Promise((resolve) => {
        const handler = (ev) => {
          if (ev === null) {
            resolve(null);  // used to cleanup
          } else if (ev.source === frame.contentWindow) {
            resolve(ev.data);
          } else {
            return false;  // not our message
          }
          window.removeEventListener('message', handler);
        };
        window.addEventListener('message', handler);
        frame.addEventListener('load', () => {
          // After ~messageDelay, assume nothing is coming.
          window.setTimeout(() => handler(null), 1000);
        });
      });
    }

    ready(frame, href, payload) {

    }
  };

  const makeLoader = (local) => {
    const container = Object.assign(document.createElement('div'), {
      className: 'iframe-container',
    });
    const loader = new TestLoader(container);
    document.body.append(container);

    const prefix = (local ? location.origin : 'http://127.0.0.1:9000') + location.pathname;
    console.info(prefix);

    let n = -1;
    const button = Object.assign(document.createElement('button'), {
      textContent: 'Load',
      tabIndex: '-1',
      onclick() {
        n = (n + 1) % pagesToLoad.length;
        const u = new URL('./' + pagesToLoad[n], prefix);

        loader.load(u.toString()).then((port) => {
          if (port === undefined) {
            return;
          }
          if (port !== undefined) {
            console.info('got active port', port);
            if (port) {
              port.postMessage({'hello': 123});
              portForFrame.add()
            }
          }
        });
      },
    });
    document.body.append(button);
  };

  makeLoader();
  makeLoader(true);

</script>

<style type="text/css">

  .iframe-container {
    height: 200px;
    position: relative;
  }
  .iframe-container iframe {
    width: 200px;
    height: 100%;
    box-sizing: border-box;
  }
  .iframe-container iframe:hover {
    box-shadow: 0 0 4px red;
  }
  .iframe-container iframe[tabindex] {
    pointer-events: none;
    opacity: 0.5;
  }

</style>

</head>
<body>

</body>
</html>
